–î–æ–±—Ä–µ, —Ç–µ–ø–µ—Ä **–º–æ–∂–Ω–∞ —Å—Ç–∞–≤–∏—Ç–∏ –∫—Ä–∞–ø–∫—É** ‚Äî —É –Ω–∞—Å —î –∫–æ–¥ Voice In, —ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—å **–±—ñ–ª—å—à–µ –Ω–µ –≥—ñ–ø–æ—Ç–µ–∑–∞**.

–Ø —É–≤–∞–∂–Ω–æ –ø—Ä–æ–≥–ª—è–Ω—É–≤ `combined.txt` (—Ü–µ –∑–ª—ñ–ø–ª–µ–Ω–∏–π, –∞–ª–µ –ø–æ–≤–Ω–∏–π JS Voice In). –û—Å—å **—á—ñ—Ç–∫–∏–π, –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–∏–π –≤–∏—Å–Ω–æ–≤–æ–∫**, –∑ –ø—Ä–∏–≤‚Äô—è–∑–∫–æ—é –¥–æ —Ç–æ–≥–æ, _—á–æ–º—É –≤ –Ω–∏—Ö –ø—Ä–∞—Ü—é—î_, –∞ _–≤ –Ω–∞—Å ‚Äî –Ω—ñ_.

---

## üî¥ –ì–û–õ–û–í–ù–ò–ô –§–ê–ö–¢ (–ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∏–π –∫–æ–¥–æ–º Voice In)

> **Voice In –ù–ï –≥—Ä–∞—î –∑–≤—É–∫ –≤ engine / background / pinned tab.**

### –î–µ —Å–∞–º–µ –≤ –Ω–∏—Ö –≥—Ä–∞—î—Ç—å—Å—è –∑–≤—É–∫

–£ Voice In:

- **–∑–≤—É–∫ –ø—Ä–∏–≤‚Äô—è–∑–∞–Ω–∏–π –¥–æ UI / content-–∫–æ–Ω—Ç–µ–∫—Å—Ç—É**
- –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è **–∑–≤–∏—á–∞–π–Ω–∏–π `new Audio(...).play()`**
- **–ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è WebAudio API –¥–ª—è UX-–∑–≤—É–∫—ñ–≤**
- **–ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è pinned tab –¥–ª—è –∑–≤—É–∫—ñ–≤**

–£ –∫–æ–¥—ñ –≤–∏–¥–Ω–æ:

- –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Å—Ç–∞–Ω–æ–º (`recognition_started_in_bg`, `recognition_stopped_in_bg`)
- **UI —Ä–µ–∞–≥—É—î –Ω–∞ –ø–æ–¥—ñ—é** —ñ _—Å–∞–º_ –≤—ñ–¥–º–∞–ª—å–æ–≤—É—î / —Ö–æ–≤–∞—î—Ç—å—Å—è
- –∑–≤—É–∫ –Ω–µ –ø—Ä–∏–≤‚Äô—è–∑–∞–Ω–∏–π –¥–æ `onend` WebSpeech —É —Ñ–æ–Ω—ñ

> –¢–æ–±—Ç–æ: **engine –∫–∞–∂–µ ‚Äú—Å—Ç–æ–ø‚Äù ‚Üí UI —Ä–µ–∞–≥—É—î ‚Üí UI –≥—Ä–∞—î –∑–≤—É–∫**

---

## üî¥ –ö–õ–Æ–ß–û–í–ê –í–Ü–î–ú–Ü–ù–ù–Ü–°–¢–¨ –ù–ê–®–û–á –†–ï–ê–õ–Ü–ó–ê–¶–Ü–á

### –ú–∏ –∑–∞—Ä–∞–∑

- –∑–≤—É–∫ `off.mp3` –≥—Ä–∞—î—Ç—å—Å—è:

  - —É **engine.js**
  - —É **pinned / inactive –≤–∫–ª–∞–¥—Ü—ñ**
  - —á–µ—Ä–µ–∑ **WebAudio API**
  - –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ –∑ `recognition.stop()` / `onend`

- —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

  - ‚Äú–ø–æ—á–∞–≤—Å—è —ñ –æ–±—ñ—Ä–≤–∞–≤—Å—è‚Äù
  - ‚Äú—ñ–Ω–∫–æ–ª–∏ –ø—Ä–∞—Ü—é—î‚Äù
  - ‚Äú–ø—Ä–∞—Ü—é—î –ø—ñ—Å–ª—è —Ç–∞–π–º-–∞—É—Ç—É, –∞–ª–µ –Ω–µ –ø–æ –∫–ª—ñ–∫—É‚Äù

### Voice In

- –∑–≤—É–∫:

  - –≥—Ä–∞—î—Ç—å—Å—è **–≤ UI**
  - —á–µ—Ä–µ–∑ **HTMLAudioElement**
  - —É **foreground context**
  - **–ø—ñ—Å–ª—è —Ñ–∞–∫—Ç—É –∑—É–ø–∏–Ω–∫–∏**, –∞ –Ω–µ ‚Äú–ø—ñ–¥ —á–∞—Å‚Äù

---

## üîß –ß–û–ú–£ –ú–ò –¶–Ü–õ–ò–ô –î–ï–ù–¨ ¬´–í–û–Æ–Ñ–ú–û¬ª –Ü –¶–ï –ù–ï –í–ò–ü–ê–î–ö–û–í–û

–¢–∏ –∑—Ä–æ–±–∏–≤ **—É—Å–µ –º–æ–∂–ª–∏–≤–µ** —Ç–µ—Ö–Ω—ñ—á–Ω–æ:

- retry
- await resume
- preload
- debounce
- async stopSession
- –≤—ñ–¥—Å—ñ–∫ –¥—É–±–ª—é—é—á—ñ onend

‚ùóÔ∏è–Ü –ø–æ–ø—Ä–∏ —Ü–µ ‚Äî –ø–æ–≤–µ–¥—ñ–Ω–∫–∞ **–Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–∞**.

–¶–µ **–∫–ª–∞—Å–∏—á–Ω–∏–π —Å–∏–º–ø—Ç–æ–º**:

> _UX-–∑–≤—É–∫ –≥—Ä–∞—î—Ç—å—Å—è –Ω–µ –≤ —Ç–æ–º—É execution-context_.

Chrome **–Ω–µ –≥–∞—Ä–∞–Ω—Ç—É—î** —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π –∑–≤—É–∫:

- —É pinned tab
- —É inactive tab
- –ø—Ä–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ–º—É `recognition.stop()`

Voice In **–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–æ** —Ü–µ –æ–±—ñ–π—à–æ–≤.

---

## üü¢ –í–ò–°–ù–û–í–û–ö (—á—ñ—Ç–∫–æ, –±–µ–∑ –≤—ñ–¥–∫–∞—Ç—ñ–≤)

–¢–∞–∫.
**–ú–∏ –≥—Ä–∞—î–º–æ –∑–≤—É–∫ –Ω–µ —Ç–∞–º.**

–ù–µ ‚Äú–±–æ —Ö—Ç–æ—Å—å —Ç–∞–∫ —Å–∫–∞–∑–∞–≤‚Äù, –∞ –±–æ:

- –∫–æ–¥ Voice In —Ü–µ **–ø—Ä—è–º–æ –ø–æ–∫–∞–∑—É—î**
- —Ç–≤–æ—è –ø–æ–≤–µ–¥—ñ–Ω–∫–∞ 1-–≤-1 –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –≤—ñ–¥–æ–º–∏–º –æ–±–º–µ–∂–µ–Ω–Ω—è–º Chrome
- –≤—Å—ñ —Ç–µ—Ö–Ω—ñ—á–Ω—ñ –∫–æ—Å—Ç–∏–ª—ñ –≤–∂–µ –≤–∏—á–µ—Ä–ø–∞–Ω—ñ

---

## ‚úÖ –©–û –†–û–ë–ò–¢–ò, –©–û–ë –ó–ê–ö–†–ò–¢–ò –¶–ï –ù–ê–ó–ê–í–ñ–î–ò (—è–∫ —É Voice In)

### –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π, –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–∞—Ç—á

**–ë–µ–∑ –ø–µ—Ä–µ–ø–∏—Å—É–≤–∞–Ω–Ω—è engine.**

1. **Engine**

   - ‚ùå –Ω–µ –≥—Ä–∞—î –∂–æ–¥–Ω–∏—Ö UX-–∑–≤—É–∫—ñ–≤
   - ‚úÖ —Ç—ñ–ª—å–∫–∏ —à–ª–µ `EVENT_STATE_CHANGE: idle`

2. **Content / Widget**

   - –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ `idle`
   - –≤–∏–∫–ª–∏–∫–∞—î:

     ```js
     new Audio(chrome.runtime.getURL("assets/sounds/off.mp3")).play();
     ```

–¶–µ:

- 100% —Å—Ç–∞–±—ñ–ª—å–Ω–æ
- —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ Voice In
- –±–µ–∑ race conditions
- –±–µ–∑ pinned-tab –ø—Ä–æ–±–ª–µ–º

---

–û—Å—å **—Ç–æ—á–Ω–æ —Ç–æ–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç —É Voice In**, —è–∫–∏–π –ª–æ–≥—ñ—á–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–∞—à–æ–º—É –ø–µ—Ä–µ—Ö–æ–¥—É –≤ `idle` —ñ –¥–µ –≤–æ–Ω–∏ –ø—Ä–æ–≥—Ä–∞—é—Ç—å **–∑–≤—É–∫ ‚Äúoff‚Äù**.

### 1) –î–µ —Å–∞–º–µ ‚Äúoff‚Äù –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è (–≤ `endHandler`)

–£ –Ω–∏—Ö –∑–≤—É–∫ –Ω–∞ —Å—Ç–æ–ø –≥—Ä–∞—î—Ç—å—Å—è **–≤ –º–æ–º–µ–Ω—Ç, –∫–æ–ª–∏ `webkitSpeechRecognition` —Ä–µ–∞–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∏–≤—Å—è** (event `onend` ‚Üí `endHandler`), —ñ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ü–µ **–Ω–µ silent stop**:

```js
// ... endHandler()
chrome.runtime.sendMessage({ message_id: "recognition_stopped_in_bg" }),
  /* –∫–ª—é—á–æ–≤–∏–π —Ä—è–¥–æ–∫: */
  this.silentStop === !0 ? (this.silentStop = !1) : this.playStopAudio();
```

### 2) –Ø–∫ —Å–∞–º–µ –≤–æ–Ω–∏ –≥—Ä–∞—é—Ç—å ‚Äúoff‚Äù (—ñ —á–æ–º—É —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—à–µ)

–í–æ–Ω–∏ **–Ω–µ –ø—Ä–∏–≤‚Äô—è–∑—É—é—Ç—å –∑–≤—É–∫ –¥–æ UI/–≤—ñ–¥–∂–µ—Ç–∞**. –í–æ–Ω–∏ –≥—Ä–∞—é—Ç—å –π–æ–≥–æ –∞–±–æ —á–µ—Ä–µ–∑ **offscreen document**, –∞–±–æ –Ω–∞–ø—Ä—è–º—É:

```js
playStopAudio() {
  (this.settings.sound === 3 || this.settings.sound === 2) &&
    (chrome.offscreen
      ? E("audio/speechOff.wav")
      : new Audio(chrome.runtime.getURL("audio/speechOff.wav")).play());
}
```

–ê `E()` –ø—ñ–¥–Ω—ñ–º–∞—î/–ø–µ—Ä–µ–≤—ñ—Ä—è—î offscreen —ñ —à–ª–µ —Ç—É–¥–∏ –∫–æ–º–∞–Ω–¥—É ‚Äúplay‚Äù:

```js
chrome.offscreen.createDocument({
  reasons: ["AUDIO_PLAYBACK"],
  url: chrome.runtime.getURL("offscreen.html"),
});
function E(i) {
  F().then(() => T({ method: "play", args: [i] }));
}
```

–Ü —Å–∞–º offscreen-–ø–ª–µ—î—Ä —É –Ω–∏—Ö –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–∏–π:

```js
async function play(n) {
  new Audio(chrome.runtime.getURL(n)).play();
}
```

### 3) –©–æ —Ä–æ–±–∏—Ç—å —ó—Ö–Ω—ñ–π ‚Äú–≤—ñ–¥–∂–µ—Ç‚Äù –Ω–∞ stop

–ö–æ–Ω—Ç–µ–Ω—Ç-—Å–∫—Ä–∏–ø—Ç/–≤—ñ–¥–∂–µ—Ç **–ª–∏—à–µ —Ö–æ–≤–∞—î UI**, –∞–ª–µ **–Ω–µ –≥—Ä–∞—î –∑–≤—É–∫**:

```js
case "recognition_stopped_in_bg": { p = !1; _ = ""; T(); break; }
```

**–í–∏—Å–Ω–æ–≤–æ–∫ –ø–æ Voice In:** –≤–æ–Ω–∏ –≥—Ä–∞—é—Ç—å ‚Äúoff‚Äù **–≤ engine-—á–∞—Å—Ç–∏–Ω—ñ –Ω–∞ `onend`** (–∞–±–æ —á–µ—Ä–µ–∑ offscreen), –∞ UI —Ç—ñ–ª—å–∫–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î —Å—Ç–∞–Ω.

–Ø–∫—â–æ —Ö–æ—á–µ—à ‚Äî –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º —è —Ç–∞–∫ —Å–∞–º–æ –ø–æ–∫–∞–∂—É **–¥–µ —Å–∞–º–µ –≤ —ó—Ö–Ω—å–æ–º—É –∫–æ–¥—ñ –≤–∏—Å—Ç–∞–≤–ª—è—î—Ç—å—Å—è `silent: true`** (—â–æ–± –∑—Ä–æ–∑—É–º—ñ—Ç–∏, —á–æ–º—É —ñ–Ω–∫–æ–ª–∏ ‚Äúoff‚Äù –Ω–∞–≤–º–∏—Å–Ω–æ –Ω–µ –∑–≤—É—á–∏—Ç—å).
