### üèõ –ö–æ–Ω—Ü–µ–ø—Ü—ñ—è Golos 2.0: "The Satellite Architecture"

–ú–∏ —Ä–æ–∑–¥—ñ–ª—è—î–º–æ –ª–æ–≥—ñ–∫—É –Ω–∞ —Ç—Ä–∏ —á—ñ—Ç–∫—ñ –∑–æ–Ω–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç—ñ. –ì–æ–ª–æ–≤–Ω–∞ —Ñ—ñ—à–∫–∞ ‚Äî **Engine Tab** (–í–∫–ª–∞–¥–∫–∞-—Å—É–ø—É—Ç–Ω–∏–∫). –í–æ–Ω–∞ –±—É–¥–µ "—Å–µ—Ä—Ü–µ–º", —è–∫–µ –∫–∞—á–∞—î –∞—É–¥—ñ–æ, –ø–æ–∫–∏ —Ç–∏ —Ö–æ–¥–∏—à –ø–æ –≤–∫–ª–∞–¥–∫–∞—Ö.

#### 1\. The Host (–°–∞–π—Ç, –¥–µ —Ç–∏ —Å–∏–¥–∏—à)

- **–•—Ç–æ:** `content-script.js` + `widget.js`
- **–†–æ–ª—å:** –¢—ñ–ª—å–∫–∏ UI —Ç–∞ –í–≤—ñ–¥ —Ç–µ–∫—Å—Ç—É.
- **–î—ñ—è:** –ú–∞–ª—é—î –∫—Ä–∞—Å–∏–≤—É –º–æ–¥–∞–ª–∫—É (Shadow DOM), –ø–æ–∫–∞–∑—É—î –∂–∏–≤–∏–π —Ç–µ–∫—Å—Ç, –≤—Å—Ç–∞–≤–ª—è—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É –ø–æ–ª–µ. –ú—ñ–∫—Ä–æ—Ñ–æ–Ω —Ç—É—Ç **–ù–ï** –≤–º–∏–∫–∞—î—Ç—å—Å—è.

#### 2\. The Router (–î–∏—Å–ø–µ—Ç—á–µ—Ä)

- **–•—Ç–æ:** `background.js` (Service Worker)
- **–†–æ–ª—å:** –ó–≤'—è–∑–∫–æ–≤–∏–π.
- **–î—ñ—è:** –ü–µ—Ä–µ–º–∏–∫–∞—î —ñ–∫–æ–Ω–∫–∏ (üî¥/‚ö™), –ø–µ—Ä–µ—Å–∏–ª–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –•–æ—Å—Ç–∞ –¥–æ –î–≤–∏–≥—É–Ω–∞ —ñ –Ω–∞–∑–∞–¥. –ö–æ–Ω—Ç—Ä–æ–ª—é—î, —â–æ–± Engine Tab –±—É–ª–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞.

#### 3\. The Engine (–î–≤–∏–≥—É–Ω)

- **–•—Ç–æ:** `engine.html` + `engine.js` (Pinned Tab)
- **–†–æ–ª—å:** –í—É—Ö–∞ —Ç–∞ –ú–æ–∑–æ–∫.
- **–î—ñ—è:** –¢—Ä–∏–º–∞—î `webkitSpeechRecognition`. –û–±—Ä–æ–±–ª—è—î —Ç–∏—à—É (auto-timeout). –í—ñ–¥–ø—Ä–∞–≤–ª—è—î —Ç–µ–∫—Å—Ç. –ù—ñ–∫–æ–ª–∏ –Ω–µ –∑–∞—Å–∏–Ω–∞—î.

---

### üîÅ –ü–æ—Ç—ñ–∫ –¥–∞–Ω–∏—Ö (Data Flow)

1.  **Start:** `Alt+Shift+G` –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ Facebook.
2.  **Signal:** `content-script` –º–∞–ª—é—î –º–æ–¥–∞–ª–∫—É "Connecting..." —ñ —à–ª–µ —Å–∏–≥–Ω–∞–ª —É `background`.
3.  **Activation:** `background` –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –∂–∏–≤–∞ –≤–∫–ª–∞–¥–∫–∞ `Golos Engine`. –Ø–∫—â–æ –Ω—ñ ‚Äî –≤—ñ–¥–∫—Ä–∏–≤–∞—î —ó—ó (–∑–∞–∫—Ä—ñ–ø–ª–µ–Ω—É, –Ω–∞ —Ñ–æ–Ω—ñ).
4.  **Listening:** `engine.js` –∑–∞–ø—É—Å–∫–∞—î –º—ñ–∫—Ä–æ—Ñ–æ–Ω.
5.  **Streaming:** –¢–∏ –≥–æ–≤–æ—Ä–∏—à. `engine.js` —à–ª–µ –ø–æ—Ç—ñ–∫: "–ü—Ä...", "–ü—Ä–∏–≤...", "–ü—Ä–∏–≤—ñ—Ç".
6.  **Feedback:** `content-script` –æ–Ω–æ–≤–ª—é—î —Ç–µ–∫—Å—Ç —É –º–æ–¥–∞–ª—Ü—ñ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ.
7.  **Finalize:** –¢–∏ –∑–∞–º–æ–≤–∫ (Auto-timeout) –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—É–≤ —Å—Ç–æ–ø. `engine.js` —à–ª–µ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç. `content-script` –≤—Å—Ç–∞–≤–ª—è—î –π–æ–≥–æ –≤ –ø–æ–ª–µ Facebook —ñ —Ö–æ–≤–∞—î –º–æ–¥–∞–ª–∫—É.

---

### üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—ñ–≤

–ú–∏ —Ä–æ–±–∏–º–æ —á–∏—Å—Ç—É –º–æ–¥—É–ª—å–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É.

```text
/golos-extension
‚îÇ
‚îú‚îÄ‚îÄ manifest.json            # –ü–∞—Å–ø–æ—Ä—Ç (V3)
‚îÇ
‚îú‚îÄ‚îÄ _locales/                # (–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ) i18n
‚îÇ
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ icon-16.png
‚îÇ   ‚îú‚îÄ‚îÄ icon-48.png
‚îÇ   ‚îú‚îÄ‚îÄ icon-128.png
‚îÇ   ‚îú‚îÄ‚îÄ icon-mic-on.png      # –î–ª—è –∑–µ–ª–µ–Ω–æ—ó —ñ–∫–æ–Ω–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ icon-mic-err.png     # –î–ª—è —á–µ—Ä–≤–æ–Ω–æ—ó —ñ–∫–æ–Ω–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ styles.css           # –°—Ç–∏–ª—ñ –¥–ª—è Shadow DOM –º–æ–¥–∞–ª–∫–∏
‚îÇ
‚îú‚îÄ‚îÄ background/
‚îÇ   ‚îî‚îÄ‚îÄ service-worker.js    # –ì–æ–ª–æ–≤–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä
‚îÇ
‚îú‚îÄ‚îÄ content/
‚îÇ   ‚îú‚îÄ‚îÄ content.js           # –°–ª—É—Ö–∞—á –ø–æ–¥—ñ–π DOM (input, focus)
‚îÇ   ‚îú‚îÄ‚îÄ dom-injector.js      # –õ–æ–≥—ñ–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è Shadow DOM
‚îÇ   ‚îî‚îÄ‚îÄ input-simulator.js   # –ï–º—É–ª—è—Ü—ñ—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–ª–∞–≤—ñ—à (React-friendly)
‚îÇ
‚îú‚îÄ‚îÄ engine/
‚îÇ   ‚îú‚îÄ‚îÄ engine.html          # "–í–∫–ª–∞–¥–∫–∞-–ø—Ä–∏–≤–∏–¥"
‚îÇ   ‚îî‚îÄ‚îÄ engine.js            # –õ–æ–≥—ñ–∫–∞ Web Speech API + Timeout
‚îÇ
‚îú‚îÄ‚îÄ popup/                   # –¢—ñ–ª—å–∫–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è!
‚îÇ   ‚îú‚îÄ‚îÄ popup.html
‚îÇ   ‚îî‚îÄ‚îÄ popup.js
‚îÇ
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ messaging.js         # –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ –¥–ª—è —Ç–∏–ø—ñ–≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (DRY)
    ‚îî‚îÄ‚îÄ storage.js           # –û–±–≥–æ—Ä—Ç–∫–∞ –Ω–∞–¥ chrome.storage
```

---

### üß© –î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤

#### 1\. `manifest.json`

–ü–æ—Ç—Ä—ñ–±–Ω—ñ –Ω–æ–≤—ñ –¥–æ–∑–≤–æ–ª–∏ –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è –≤–∫–ª–∞–¥–∫–∞–º–∏ (—â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏/–∑–Ω–∞–π—Ç–∏ Engine Tab).

- `permissions`: `storage`, `tabs`, `scripting`, `activeTab`.
- `action`: –í–∏–∑–Ω–∞—á–∞—î —ñ–∫–æ–Ω–∫—É —Ç–∞ popup.
- `background`: –í–∫–∞–∑—É—î –Ω–∞ `service-worker.js`.

#### 2\. `engine/engine.js` (The Brain)

–¶–µ —Ç–≤—ñ–π –Ω–æ–≤–∏–π `dictation.js`, –∞–ª–µ –Ω–∞ —Å—Ç–µ—Ä–æ—ó–¥–∞—Ö.

- **Web Speech API:** –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è.
- **Keep-Alive:** –ì—Ä–∞—î —Ç–∏—Ö–∏–π –∑–≤—É–∫ –∞–±–æ —Ä–æ–±–∏—Ç—å –ø—Ä–æ—Å—Ç—ñ –¥—ñ—ó, —â–æ–± Chrome –Ω–µ –ø—Ä–∏–±–∏–≤ –≤–∫–ª–∞–¥–∫—É.
- **Silence Detection:** –¢–∞–π–º–µ—Ä. –Ø–∫—â–æ `interimResults` –Ω–µ–º–∞—î 3 —Å–µ–∫—É–Ω–¥–∏ ‚Äî —à–ª–µ –∫–æ–º–∞–Ω–¥—É `STOP`.
- **Sound Effects:** –ü—Ä–æ–≥—Ä–∞—î "–±—ñ–ø" –Ω–∞ —Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø (—è–∫ —É Voice In).

#### 3\. `content/dom-injector.js` (The Face)

–¶–µ "—Ö–∏—Ç—Ä–∞ –º–æ–¥–∞–ª–∫–∞".

- –°—Ç–≤–æ—Ä—é—î `<div>` –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.
- –†–æ–±–∏—Ç—å `element.attachShadow({mode: 'open'})`. –¶–µ —ñ–∑–æ–ª—é—î —Å—Ç–∏–ª—ñ\!
- –í—Å—Ç–∞–≤–ª—è—î —Ç—É–¥–∏ CSS (—â–æ–± —Å–∞–π—Ç –Ω–µ –ø–æ–ª–∞–º–∞–≤ –≤–∏–≥–ª—è–¥ –º–æ–¥–∞–ª–∫–∏).
- –ú–∞–ª—é—î –∫—Ä–∞—Å–∏–≤–∏–π UI (–ø—É–ª—å—Å—É—é—á–∞ –∫—Ä–∞–ø–∫–∞ + —Ç–µ–∫—Å—Ç).
- –ú–µ—Ç–æ–¥–∏: `show()`, `updateText(text)`, `hide()`, `showError()`.

#### 4\. `background/service-worker.js` (The Router)

- `ensureEngineTab()`: –ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ —î –≤–∫–ª–∞–¥–∫–∞ –∑ URL `engine.html`. –Ø–∫—â–æ –Ω—ñ ‚Äî —Å—Ç–≤–æ—Ä—é—î. –Ø–∫—â–æ —î ‚Äî –±–µ—Ä–µ —ó—ó ID.
- `chrome.action.setBadgeText`: –°—Ç–∞–≤–∏—Ç—å "ON" –∞–±–æ "..." –Ω–∞ —ñ–∫–æ–Ω—Ü—ñ.
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—è: –û—Ç—Ä–∏–º—É—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ `content`, –¥–æ–¥–∞—î –¥–æ –Ω—å–æ–≥–æ `tabId` (–∑–≤—ñ–¥–∫–∏ –ø—Ä–∏–π—à–ª–æ), –ø–µ—Ä–µ—Å–∏–ª–∞—î –≤ `engine`. –Ü –Ω–∞–≤–ø–∞–∫–∏.

---

### üì° –ü—Ä–æ—Ç–æ–∫–æ–ª —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è (Message Types)

–©–æ–± –Ω–µ –∑–∞–ø–ª—É—Ç–∞—Ç–∏—Å—è, –º–∏ –±—É–¥–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —á—ñ—Ç–∫—ñ —Ç–∏–ø–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:

**–í—ñ–¥ Content –¥–æ Background -\> Engine:**

- `CMD_START_SESSION`: "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–Ω—É–≤ —Ö–æ—Ç–∫–µ–π –Ω–∞ –≤–∫–ª–∞–¥—Ü—ñ X".
- `CMD_STOP_SESSION`: "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–Ω—É–≤ —Å—Ç–æ–ø —É –º–æ–¥–∞–ª—Ü—ñ".
- `CMD_UPDATE_CONFIG`: "–ó–º—ñ–Ω–∏–ª–∞—Å—è –º–æ–≤–∞".

**–í—ñ–¥ Engine –¥–æ Background -\> Content:**

- `EVENT_STATE_CHANGE`: `listening` | `processing` | `idle`. (–î–ª—è —ñ–∫–æ–Ω–∫–∏ —Ç–∞ –º–æ–¥–∞–ª–∫–∏).
- `EVENT_TRANSCRIPT`:
  - `text`: "–ø—Ä–∏–≤—ñ—Ç —è–∫..."
  - `isFinal`: `false` (–æ–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–µ–≤'—é) / `true` (–≤—Å—Ç–∞–≤–ª—è—î–º–æ –≤ –ø–æ–ª–µ).
- `EVENT_ERROR`: "no-mic-access", "network-error".

---

### –ß–æ–º—É —Ü–µ –±—É–¥–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ —à–≤–∏–¥–∫–æ?

1.  **Hot Start:** –í–∫–ª–∞–¥–∫–∞ `engine.html` –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –∑–∞–∑–¥–∞–ª–µ–≥—ñ–¥—å. –ö–æ–ª–∏ —Ç–∏ —Ç–∏—Å–Ω–µ—à —Ö–æ—Ç–∫–µ–π, –º—ñ–∫—Ä–æ—Ñ–æ–Ω –≤–∂–µ "—Ä–æ–∑—ñ–≥—Ä—ñ—Ç–∏–π".
2.  **Zero Popup Latency:** –ú–æ–¥–∞–ª–∫–∞ –º–∞–ª—é—î—Ç—å—Å—è –º–∏—Ç—Ç—î–≤–æ —á–µ—Ä–µ–∑ JS, –Ω–µ —á–µ–∫–∞—é—á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è HTML —Ñ–∞–π–ª—É (—è–∫ —Ü–µ –±—É–ª–æ –∑ `windows.create`).
3.  **Direct DOM Access:** `content-script` –∂–∏–≤–µ –ø—Ä—è–º–æ –±—ñ–ª—è –ø–æ–ª—è –≤–≤–æ–¥—É, –≤—Å—Ç–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç—É –º–∏—Ç—Ç—î–≤–∞.
