# Golos - Розширення Chrome для диктування тексту

Golos — це розширення для браузера Google Chrome, яке дозволяє диктувати текст з мікрофона безпосередньо в будь-яке поле вводу на веб-сайті. Воно використовує вбудований API розпізнавання мови (SpeechRecognition) у Chrome, без потреби в зовнішніх серверах для базового функціоналу. На першому етапі підтримується українська та англійська мови. Розширення забезпечує зручний інтерфейс для диктування, автоматичну вставку тексту, обробку макросів для пунктуації та автоматичне зупинення сесії при тривалій тиші.

Мета проекту — створити просте, швидке та приватне рішення для голосового вводу, з можливістю розширення на інші мови та словники в майбутніх версіях.

## Можливості

- **Голосовий ввід у будь-яке поле**: Диктуйте в текстові поля, textarea або contenteditable елементи на будь-якому сайті.
- **Підтримка мов**: Українська (uk-UA) та англійська (en-US) за замовчуванням, з можливістю вибору в налаштуваннях.
- **Макроси для пунктуації**: Спеціальні команди, як "кома", "крапка", "новий рядок", для вставки символів без ручного вводу.
- **Інтерфейс віджету**: Плаваючий віджет на сторінці з індикатором стану, текстом у реальному часі та кнопкою зупинки.
- **Автоматичне зупинення**: Сесія завершується після 20 секунд тиші або при зміні вкладки.
- **Налаштування**: Вибір мови через контекстне меню.
- **Візуальний індикатор**: Іконка розширення змінює колір (зелений — неактивний, червоний — запис) та показує бейдж "ON" під час сесії.
- **API для корекції тексту**: Окрема серверна частина (golos-api) на Node.js з OpenAI для виправлення помилок, але наразі не інтегрована в основний двигун (для майбутнього використання).

## Встановлення

1. **Клонування репозиторію**:
   ```
   git clone https://github.com/your-repo/golos.git
   ```
2. **Завантаження в Chrome**:
   - Відкрийте `chrome://extensions/` у браузері.
   - Увімкніть "Режим розробника" (у правому верхньому куті).
   - Натисніть "Завантажити розпаковане розширення" та оберіть папку `golos-extension`.
3. **Для серверної частини (golos-api)** (опціонально, якщо потрібна корекція тексту):

   - Перейдіть до `golos-extension/golos-api`.
   - Встановіть залежності: `pnpm install` (або `npm install`).
   - Створіть файл `.env` з ключем OpenAI: `OPENAI_API_KEY=your_key_here`.
   - Запустіть сервер: `node index.js`.
   - Сервер працюватиме на `http://127.0.0.1:3000`.

4. **Гаряча клавіша**: За замовчуванням — `Ctrl+Shift+S` (або `Cmd+Shift+S` на Mac) для запуску/зупинки. Налаштуйте в `chrome://extensions/shortcuts`.

## Використання

1. **Запуск сесії**:

   - Натисніть на іконку розширення (ЛКМ) або використайте гарячу клавішу.
   - Розширення перевірить, чи є активне поле вводу на сторінці. Якщо ні — покаже помилку (бейдж "NO" або "ERR").
   - Якщо все ок — іконка стане червоною, з'явиться віджет "Golos" на сторінці з індикатором "Слухаю...".

2. **Диктування**:

   - Говоріть у мікрофон. Текст з'являтиметься в віджеті в реальному часі (проміжний — сірий, фінальний — чорний).
   - Використовуйте макроси: скажіть "кома" для ",", "новий рядок" для "\n" тощо.
   - Фінальний текст автоматично вставлятиметься в активне поле вводу з урахуванням позиції курсора.

3. **Зупинка**:

   - Натисніть на іконку знову, хрестик у віджеті, або змініть вкладку.
   - Сесія зупиниться автоматично після 20 секунд тиші.

4. **Налаштування**:
   - ПКМ на іконці → "⚙️ Налаштування Golos".
   - Оберіть мову (uk-UA або en-US) та збережіть.

## Архітектура та принцип роботи

Розширення побудоване на модульній структурі з використанням Chrome Extensions API (Manifest V3). Головний принцип: розділення логіки на фоновий скрипт (router), двигун розпізнавання (engine), контент-скрипти (host) та утиліти. Повідомлення між модулями здійснюються через `chrome.runtime.sendMessage` та `chrome.tabs.sendMessage`.

### Головні модулі

- **Background (service-worker.js)**:

  - Це "маршрутизатор" (router): керує сесією, створює/перевіряє приховану вкладку для двигуна (`engine/engine.html`).
  - Обробляє toggle (запуск/зупинку) через клік на іконці або гарячу клавішу.
  - Візуалізує стан: змінює іконку (зелена/червона) та бейдж ("ON", "ERR" тощо).
  - Перевіряє активну вкладку: забороняє диктування на chrome:// сторінках; питає контент-скрипт, чи є поле вводу.
  - Авто-зупинка при зміні вкладки.
  - Контекстне меню для налаштувань.

- **Content (content.js, dom-injector.js, input-simulator.js)**:

  - **content.js**: Головний хост — завантажує модулі, обробляє повідомлення від background/engine, показує/ховає віджет.
  - **dom-injector.js**: Клас GolosWidget — створює shadow DOM віджет (плаваючий блок з заголовком, статусом, текстом та хрестиком). Підтримує drag & drop (перетягування мишкою), зберігає позицію в local storage.
  - **input-simulator.js**: Функції для вставки тексту: знаходить активне поле вводу (input, textarea, contenteditable), вставляє текст з урахуванням курсора, додає пробіл якщо потрібно, симулює події input/change.
  - Особливість: Віджет монтується в shadow DOM для ізоляції від стилів сторінки; позиція зберігається глобально.

- **Engine (engine.html, engine.js)**:

  - Прихована вкладка (pinned, неактивна) для стабільної роботи SpeechRecognition API (бо content scripts не мають доступу до мікрофона в MV3).
  - **engine.js**: Ініціалізує SpeechRecognition з обраною мовою (з sync storage).
  - Обробляє події: onstart (слухає), onend (зупинка), onresult (проміжний/фінальний текст).
  - Застосовує макроси: замінює слова на символи (кома → ",", тощо), чистить пробіли, капіталізує першу літеру.
  - Таймер тиші: зупиняє після 20 сек без мовлення.
  - Надсилає транскрипти та стани через background до content.
  - Особливість: Continuous + interimResults для реального часу; обробка помилок (крім "no-speech" для тиші).

- **Golos-api (index.js, package.json)**:

  - Окрема Node.js серверна частина для корекції тексту за допомогою OpenAI (gpt-4o-mini).
  - Ендпоінти: `/health` (перевірка ключа), `/process` (виправлення тексту з режимами: uk-clean, en-clean, uk-en-mix).
  - Інструкції для AI: виправляти орфографію/граматику, але зберігати зміст і не чіпати англійські вставки.
  - Особливість: Не інтегрована в поточний двигун (engine.js не викликає API), ймовірно, для майбутнього етапу (наприклад, пост-обробка тексту). Потребує локального запуску сервера.

- **Options (options.html, options.js)**:

  - Сторінка налаштувань: вибір мови (select), збереження в sync storage.
  - Показує статус "Збережено" після натискання кнопки.

- **Utils (messaging.js)**:

  - Константи для типів повідомлень (CMD_START_SESSION, EVENT_TRANSCRIPT тощо) для стандартизації комунікації.

- **Assets**: Іконки (зелені/червоні), CSS для віджету, SVG мікрофона.
- **Manifest.json**: Визначає дозволи (tabs, storage, contextMenus, commands), скрипти, іконки тощо.
- **Legacy**: Старі файли (dictation.html/js) — ймовірно, прототип, не використовуються в поточній версії.

### Принцип роботи (потік)

1. Користувач натискає іконку → background перевіряє вкладку та поле вводу (через повідомлення до content).
2. Якщо ок → background створює/активує engine tab, надсилає CMD_START_SESSION з targetTabId.
3. Engine стартує SpeechRecognition, надсилає стани/транскрипти через background до content.
4. Content показує віджет, вставляє фінальний текст у поле.
5. Зупинка: через команду, таймер або зміну вкладки → CMD_STOP_SESSION, ховає віджет, скидає іконку.

## Особливості

- **Приватність**: Розпізнавання відбувається локально в браузері (SpeechRecognition від Google), без відправки аудіо на сервери (крім можливого використання API для корекції).
- **MV3 сумісність**: Використання service worker та tabs для двигуна, оскільки content scripts не мають прямого доступу до мікрофона.
- **Макроси**: Автоматична обробка пунктуації з чисткою пробілів (наприклад, "привіт кома як справи" → "Привіт, як справи").
- **Drag & Drop віджету**: Позиція зберігається в local storage; автоматично "прилипає" до країв екрана.
- **Обмеження**: Працює тільки в Chrome (через SpeechRecognition); потребує дозволу на мікрофон. Не працює на системних сторінках (chrome://).
- **Потенціал розширення**: Додавання словників, інтеграція з golos-api для AI-корекції, підтримка інших мов.

## Відомі проблеми

- Якщо сторінка блокує shadow DOM або має строгий CSP — віджет може не відобразитися правильно.
- SpeechRecognition може мати помилки в шумному середовищі; немає ручної обробки помилок мікрофона.
- Golos-api не інтегрована: для використання потрібно вручну додати виклики в engine.js (наприклад, після applyMacros).
- Транкейтед код у combined.txt: деякі частини (наприклад, dom-injector.js) обрізані, але основна логіка зрозуміла.

## Внески

Вітаються pull requests! Для внесків:

- Форкніть репозиторій.
- Створіть гілку: `git checkout -b feature/new-feature`.
- Комітьте зміни: `git commit -m 'Add new feature'`.
- Пуште: `git push origin feature/new-feature`.
- Створіть PR.

## Ліцензія

MIT License. Деталі в LICENSE (якщо є).

## Контакти

Автор: [Airteg/golos](https://github.com/Airteg/golos). Звіти про помилки: issues на GitHub.
