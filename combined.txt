D:\ProjectsVVV\ChromeExtension\golos
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\assets
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\background
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\background\service-worker.js
--------------------------------------------------
import { MSG } from "../utils/messaging.js";

console.log("[Golos BG] Router v2.0 Started");

let engineTabId = null;

// --- 1. –ö–µ—Ä—É–≤–∞–Ω–Ω—è –≤–∫–ª–∞–¥–∫–æ—é-–¥–≤–∏–≥—É–Ω–æ–º ---

async function ensureEngineTab() {
  const engineUrl = chrome.runtime.getURL("engine/engine.html");
  try {
    const tabs = await chrome.tabs.query({ url: engineUrl });
    if (tabs.length > 0) {
      engineTabId = tabs[0].id;
      return engineTabId;
    }
    const newTab = await chrome.tabs.create({
      url: engineUrl,
      pinned: true,
      active: false,
    });
    engineTabId = newTab.id;
    return engineTabId;
  } catch (e) {
    console.error("[Golos BG] Engine error:", e);
    return null;
  }
}

// --- 2. –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞–Ω—É (–Ü–∫–æ–Ω–∫–∞ + Badge) ---

function setVisualState(state) {
  // state: 'idle' | 'listening' | 'error'

  if (state === "listening") {
    chrome.action.setBadgeText({ text: "ON" });
    chrome.action.setBadgeBackgroundColor({ color: "#ef4444" });
    // –Ø–∫—â–æ —É —Ç–µ–±–µ –±—É–¥—É—Ç—å —ñ–∫–æ–Ω–∫–∏:
    // chrome.action.setIcon({ path: "assets/icon-red.png" });
  } else {
    chrome.action.setBadgeText({ text: "" }); // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ —Ç–µ–∫—Å—Ç
    // chrome.action.setIcon({ path: "assets/icon-gray.png" });
  }
}

// --- 3. –ì–æ–ª–æ–≤–Ω–∏–π –ø–µ—Ä–µ–º–∏–∫–∞—á (Toggle) ---

async function toggleSession() {
  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å –ø–æ –±–µ–π–¥–∂—É (—Ü–µ –Ω–∞—à–µ –¥–∂–µ—Ä–µ–ª–æ –ø—Ä–∞–≤–¥–∏)
  const badgeText = await chrome.action.getBadgeText({});
  const isRunning = badgeText === "ON";

  if (isRunning) {
    // === STOP ===
    console.log("[Golos BG] Action: STOP");
    if (engineTabId) {
      chrome.tabs.sendMessage(engineTabId, { type: MSG.CMD_STOP_SESSION });
      setVisualState("idle");
    }
  } else {
    // === START ===
    console.log("[Golos BG] Action: START");

    // 1. –®—É–∫–∞—î–º–æ –∞–∫—Ç–∏–≤–Ω—É –≤–∫–ª–∞–¥–∫—É (–∫—É–¥–∏ –ø–∏—Å–∞—Ç–∏)
    const tabs = await chrome.tabs.query({
      active: true,
      lastFocusedWindow: true,
    });
    const activeTab = tabs[0];

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ —Ü–µ –Ω–µ —Å–ª—É–∂–±–æ–≤–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ (chrome://)
    if (!activeTab || !activeTab.id || activeTab.url.startsWith("chrome://")) {
      console.warn("Cannot dictate on this tab");
      // –ú–æ–∂–Ω–∞ –±–ª–∏–º–Ω—É—Ç–∏ –±–µ–π–¥–∂–µ–º "ERR"
      chrome.action.setBadgeText({ text: "ERR" });
      setTimeout(() => chrome.action.setBadgeText({ text: "" }), 1500);
      return;
    }

    // 2. –ü–æ–∫–∞–∑—É—î–º–æ –≤—ñ–¥–∂–µ—Ç
    chrome.tabs
      .sendMessage(activeTab.id, { type: "CMD_ShowWidget" })
      .catch(() => {
        console.warn("Widget not ready. Please refresh the page.");
      });

    // 3. –ó–∞–ø—É—Å–∫–∞—î–º–æ –¥–≤–∏–≥—É–Ω
    ensureEngineTab().then((engId) => {
      if (!engId) return;
      chrome.tabs.sendMessage(engId, {
        type: MSG.CMD_START_SESSION,
        targetTabId: activeTab.id,
      });
      setVisualState("listening");
    });
  }
}

// --- 4. Listeners ---

// –ö–ª—ñ–∫ –ø–æ —ñ–∫–æ–Ω—Ü—ñ (–õ–ö–ú)
chrome.action.onClicked.addListener((tab) => {
  toggleSession();
});

// –ì–∞—Ä—è—á–∞ –∫–ª–∞–≤—ñ—à–∞
chrome.commands.onCommand.addListener((command) => {
  if (command === "golos-process-selection") {
    toggleSession();
  }
});

// –°–ª—É—Ö–∞—á –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  // –Ø–∫—â–æ –≤—ñ–¥–∂–µ—Ç –ø—Ä–æ—Å–∏—Ç—å –∑—É–ø–∏–Ω–∏—Ç–∏—Å—å (—Ö—Ä–µ—Å—Ç–∏–∫)
  if (message.type === MSG.CMD_STOP_SESSION) {
    if (engineTabId) {
      chrome.tabs.sendMessage(engineTabId, { type: MSG.CMD_STOP_SESSION });
      setVisualState("idle");
    }
  }

  // –¢—Ä–∞–Ω–∑–∏—Ç –¥–∞–Ω–∏—Ö (Engine <-> Content)
  if (
    message.type === MSG.EVENT_TRANSCRIPT ||
    message.type === MSG.EVENT_STATE_CHANGE
  ) {
    // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è UI –ø—Ä–∏ –∞–≤—Ç–æ-—Å—Ç–æ–ø—ñ
    if (message.type === MSG.EVENT_STATE_CHANGE) {
      setVisualState(message.state);
    }

    const destTabId = message.targetTabId;
    if (destTabId) {
      chrome.tabs.sendMessage(destTabId, message).catch(() => {});
    }
  }
});

// –°—Ç–∞—Ä—Ç
chrome.runtime.onInstalled.addListener(() => ensureEngineTab());
chrome.runtime.onStartup.addListener(() => ensureEngineTab());
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\content
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\content\content.js
--------------------------------------------------
(async () => {
  try {
    const srcMessaging = chrome.runtime.getURL("utils/messaging.js");
    const srcWidget = chrome.runtime.getURL("content/dom-injector.js");
    const srcInput = chrome.runtime.getURL("content/input-simulator.js");

    const { MSG } = await import(srcMessaging);
    const { GolosWidget } = await import(srcWidget);
    const { insertText, getActiveEditable } = await import(srcInput);

    console.log("[Golos Host] All modules loaded");
    const widget = new GolosWidget();

    // –û–±—Ä–æ–±–∫–∞ –∫–ª—ñ–∫—É –Ω–∞ —Ö—Ä–µ—Å—Ç–∏–∫
    widget.onStopClick(() => {
      console.log("[Golos Host] User clicked Stop");
      chrome.runtime.sendMessage({ type: MSG.CMD_STOP_SESSION });
      widget.hide();
    });

    chrome.runtime.onMessage.addListener((message) => {
      if (message.type === "CMD_ShowWidget") {
        const el = getActiveEditable();
        if (el) {
          widget.show();
        } else {
          console.warn("No editable element found");
        }
      }

      if (message.type === MSG.EVENT_STATE_CHANGE) {
        widget.setStatusCode(message.state);
        // –Ø–∫—â–æ –¥–≤–∏–≥—É–Ω –∑—É–ø–∏–Ω–∏–≤—Å—è (idle), —Ö–æ–≤–∞—î–º–æ –≤—ñ–¥–∂–µ—Ç
        if (message.state === "idle") {
          setTimeout(() => widget.hide(), 500);
        }
      }

      if (message.type === MSG.EVENT_TRANSCRIPT) {
        widget.updateText(message.text, message.isFinal);
        if (message.isFinal) {
          const el = getActiveEditable();
          if (el) {
            insertText(el, message.text);
          }
        }
      }
    });
  } catch (err) {
    console.error("[Golos Host] Error:", err);
  }
})();
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\content\dom-injector.js
--------------------------------------------------
export class GolosWidget {
  constructor() {
    this.host = null;
    this.shadow = null;
    this.root = null;
    this.statusDot = null;
    this.statusText = null;
    this.contentArea = null;
    this.closeBtn = null; // –ù–û–í–ï
    this._isMounted = false;
    this.onStopCallback = null; // –ù–û–í–ï: —Ñ—É–Ω–∫—Ü—ñ—è –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –≤–∏–∫–ª–∏–∫—É
  }

  // –ú–µ—Ç–æ–¥ –¥–ª—è –ø—ñ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–ª—ñ–∫ (–≤–∏–∫–ª–∏—á–µ–º–æ –π–æ–≥–æ –≤ content.js)
  onStopClick(callback) {
    this.onStopCallback = callback;
  }

  mount() {
    if (this._isMounted) return;

    this.host = document.createElement("div");
    this.host.id = "golos-shadow-host";
    this.shadow = this.host.attachShadow({ mode: "open" });

    const linkElem = document.createElement("link");
    linkElem.setAttribute("rel", "stylesheet");
    linkElem.setAttribute("href", chrome.runtime.getURL("assets/styles.css"));
    this.shadow.appendChild(linkElem);

    const wrapper = document.createElement("div");
    wrapper.className = "golos-widget golos-hidden";
    // –ö–Ω–æ–ø–∫–∞ .golos-close
    wrapper.innerHTML = `
      <div class="golos-header">
        <div class="golos-status">
          <div class="golos-dot"></div>
          <span class="golos-status-text">Golos</span>
        </div>
        <div class="golos-close" style="cursor: pointer; padding: 4px; font-weight: bold;">‚úñ</div>
      </div>
      <div class="golos-content">
        <span class="golos-placeholder">–ì–æ–≤–æ—Ä—ñ—Ç—å...</span>
      </div>
    `;
    this.shadow.appendChild(wrapper);

    this.root = wrapper;
    this.statusDot = wrapper.querySelector(".golos-dot");
    this.statusText = wrapper.querySelector(".golos-status-text");
    this.contentArea = wrapper.querySelector(".golos-content");
    this.closeBtn = wrapper.querySelector(".golos-close"); // –ù–û–í–ï

    // –ù–û–í–ï: –°–ª—É—Ö–∞—î–º–æ –∫–ª—ñ–∫
    this.closeBtn.addEventListener("click", () => {
      if (this.onStopCallback) this.onStopCallback();
    });

    document.body.appendChild(this.host);
    this._isMounted = true;
  }

  show() {
    if (!this._isMounted) this.mount();
    this.root.classList.remove("golos-hidden");
    this.setStatusCode("connecting");
  }

  hide() {
    if (this.root) this.root.classList.add("golos-hidden");
  }

  updateText(text, isFinal) {
    if (!text) {
      this.contentArea.innerHTML =
        '<span class="golos-placeholder">–ì–æ–≤–æ—Ä—ñ—Ç—å...</span>';
      return;
    }
    this.contentArea.textContent = text;
  }

  setStatusCode(code) {
    this.statusDot.className = "golos-dot";
    switch (code) {
      case "listening":
        this.statusDot.classList.add("listening");
        this.statusText.textContent = "–°–ª—É—Ö–∞—é...";
        break;
      case "processing":
        this.statusDot.classList.add("processing");
        this.statusText.textContent = "–û–±—Ä–æ–±–∫–∞...";
        break;
      case "connecting":
        this.statusText.textContent = "–ó–∞–ø—É—Å–∫...";
        break;
      default:
        this.statusText.textContent = "Golos";
    }
  }
}
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\content\input-simulator.js
--------------------------------------------------
export function getActiveEditable() {
  const el = document.activeElement;
  if (!el) return null;

  const isInput =
    el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement;
  const isContentEditable = el.isContentEditable;

  if (isInput || isContentEditable) {
    return el;
  }
  return null;
}

export function insertText(el, text) {
  if (!el || !text) return;

  const isInput =
    el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement;

  if (isInput) {
    const start = el.selectionStart || 0;
    const end = el.selectionEnd || 0;
    const originalValue = el.value;

    const prefix = originalValue.substring(0, start);
    const suffix = originalValue.substring(end);

    const spacer = prefix.length > 0 && !prefix.endsWith(" ") ? " " : "";

    el.value = prefix + spacer + text + suffix;

    const newCursorPos = start + spacer.length + text.length;
    el.selectionStart = el.selectionEnd = newCursorPos;

    el.dispatchEvent(new Event("input", { bubbles: true }));
    el.dispatchEvent(new Event("change", { bubbles: true }));
  } else {
    // –î–ª—è contenteditable
    document.execCommand("insertText", false, text);
  }
  console.log("[Golos Input] Inserted:", text);
}
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\engine
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\engine\engine.js
--------------------------------------------------
import { MSG } from "../utils/messaging.js";

console.log("[Golos Engine] Ready to listen.");

let recognition = null; // SpeechRecognition instance
let currentTargetTabId = null; // Tab ID to send transcripts to
let silenceTimer = null; // Timer for silence detection
const SILENCE_TIMEOUT_MS = 20000; // 20 seconds

// --- –°–õ–û–í–ù–ò–ö –ú–ê–ö–†–û–°–Ü–í ---
const MACROS = {
  –∫–æ–º–∞: ",",
  –∫—Ä–∞–ø–∫–∞: ".",
  "–∑–Ω–∞–∫ –ø–∏—Ç–∞–Ω–Ω—è": "?",
  "–∑–Ω–∞–∫ –æ–∫–ª–∏–∫—É": "!",
  –¥–µ—Ñ—ñ—Å: "-",
  –¥–≤–æ–∫—Ä–∞–ø–∫–∞: ":",
  —Ç–∏—Ä–µ: " ‚Äî",
  "–Ω–æ–≤–∏–π —Ä—è–¥–æ–∫": "\n",
  –∞–±–∑–∞—Ü: "\n\n",
  "–¥—É–∂–∫–∞ –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è": "(",
  "–¥—É–∂–∫–∞ –∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è": ")",
  —Å–º–∞–π–ª–∏–∫: "üôÇ",
};

function applyMacros(text) {
  if (!text) return text;

  let processed = text;

  // 1. –ó–∞–º—ñ–Ω–∞ —Å–ª—ñ–≤ –Ω–∞ —Å–∏–º–≤–æ–ª–∏
  for (const [key, value] of Object.entries(MACROS)) {
    const regex = new RegExp(`(^|\\s)${key}(?=$|\\s|[.,?!])`, "gi");
    processed = processed.replace(regex, (match, prefix) => {
      // –Ø–∫—â–æ —Ü–µ —Ä–æ–∑–¥—ñ–ª–æ–≤–∏–π –∑–Ω–∞–∫, –º–∏ –Ω–µ —Ö–æ—á–µ–º–æ –ø—Ä–æ–±—ñ–ª –ø–µ—Ä–µ–¥ –Ω–∏–º (–æ–∫—Ä—ñ–º –¥—É–∂–∫–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è)
      if ([".", ",", "?", "!", ":", ")"].includes(value)) {
        return value;
      }
      return prefix + value;
    });
  }

  // 2. –ß–∏—Å—Ç–∫–∞ –ø—Ä–æ–±—ñ–ª—ñ–≤ (FIX –¥–ª—è –¥—É–∂–æ–∫)

  // –ü—Ä–∏–±—Ä–∞—Ç–∏ –ø—Ä–æ–±—ñ–ª–∏ –ü–ï–†–ï–î: . , ! ? : )
  processed = processed.replace(/\s+([.,?!:);])/g, "$1");

  // –ü—Ä–∏–±—Ä–∞—Ç–∏ –ø—Ä–æ–±—ñ–ª–∏ –ü–Ü–°–õ–Ø: (
  processed = processed.replace(/(\()\s+/g, "$1");

  // –î–æ–¥–∞—Ç–∏ –ø—Ä–æ–±—ñ–ª –ü–Ü–°–õ–Ø –∫–æ–º–∏/–∫—Ä–∞–ø–∫–∏, —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ "–ø—Ä–∏–≤—ñ—Ç,—è–∫")
  processed = processed.replace(/([.,?!:;])(?=[^\s])/g, "$1 ");

  return processed;
}
// --- –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –†–û–ó–ü–Ü–ó–ù–ê–í–ê–ù–ù–Ø ---
async function initRecognition() {
  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return null;

  const { golosLang } = await chrome.storage.sync.get({ golosLang: "uk-UA" });
  console.log(`[Golos Engine] Lang: ${golosLang}`);

  const rec = new SpeechRecognition();
  rec.continuous = true;
  rec.interimResults = true;
  rec.lang = golosLang;

  rec.onstart = () => {
    console.log("[Golos Engine] ON");
    sendState("listening");
    resetSilenceTimer();
  };

  rec.onend = () => {
    console.log("[Golos Engine] OFF");
    sendState("idle");
    clearTimeout(silenceTimer);
  };

  rec.onresult = (event) => {
    resetSilenceTimer();

    let interim = "";
    let final = "";

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const res = event.results[i];
      if (res.isFinal) {
        final += res[0].transcript;
      } else {
        interim += res[0].transcript;
      }
    }

    // –ó–ê–°–¢–û–°–û–í–£–Ñ–ú–û –ú–ê–ö–†–û–° –¢–Ü–õ–¨–ö–ò –î–û –§–Ü–ù–ê–õ–¨–ù–û–ì–û –¢–ï–ö–°–¢–£
    if (final) {
      final = applyMacros(final);
      // –ö–∞–ø—ñ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–µ—Ä—à–æ—ó –ª—ñ—Ç–µ—Ä–∏ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É
      final = final.charAt(0).toUpperCase() + final.slice(1);
    }

    if (currentTargetTabId) {
      chrome.runtime.sendMessage({
        type: MSG.EVENT_TRANSCRIPT,
        text: final || interim,
        isFinal: !!final,
        targetTabId: currentTargetTabId,
      });
    }
  };

  rec.onerror = (e) => {
    if (e.error !== "no-speech") sendState("error");
  };
  return rec;
}
// --- –¢–ê–ô–ú–ï–† –ë–ï–ó–î–Ü–Ø–õ–¨–ù–û–°–¢–Ü ---
function resetSilenceTimer() {
  clearTimeout(silenceTimer);
  silenceTimer = setTimeout(() => {
    console.log("[Golos Engine] Silence stop.");
    stopSession();
  }, SILENCE_TIMEOUT_MS);
}
// --- –ó–£–ü–ò–ù–ö–ê –°–ï–°–Ü–á ---
function stopSession() {
  if (recognition) recognition.stop();
  updateStatusUI("Idle");
}
// --- –í–Ü–î–ü–†–ê–í–ö–ê –°–¢–ê–ù–£ ---
function sendState(state) {
  if (currentTargetTabId) {
    chrome.runtime.sendMessage({
      type: MSG.EVENT_STATE_CHANGE,
      state: state,
      targetTabId: currentTargetTabId,
    });
  }
}
// --- –û–ë–†–û–ë–ö–ê –ü–û–í–Ü–î–û–ú–õ–ï–ù–¨ ---
chrome.runtime.onMessage.addListener((message) => {
  if (message.type === MSG.CMD_START_SESSION) {
    currentTargetTabId = message.targetTabId;
    if (recognition) recognition.abort();
    initRecognition().then((rec) => {
      recognition = rec;
      try {
        recognition.start();
        updateStatusUI(`Listening ${currentTargetTabId}`);
      } catch (e) {}
    });
    return true;
  }
  if (message.type === MSG.CMD_STOP_SESSION) stopSession();
});
// --- UI –°–¢–ê–¢–£–° ---
function updateStatusUI(text) {
  const el = document.getElementById("status");
  if (el) el.textContent = text;
}
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\golos-api
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\golos-api\index.js
--------------------------------------------------
import "dotenv/config";
import express from "express";
import cors from "cors";
import OpenAI from "openai";

const app = express();
const PORT = 3000;

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–ª—ñ—î–Ω—Ç–∞ OpenAI
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

app.use(cors());
app.use(express.json());

function getInstructions(mode) {
  switch (mode) {
    case "uk-clean":
      return (
        "–¢–∏ –∫–æ—Ä–µ–∫—Ç–æ—Ä —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—ó –º–æ–≤–∏. " +
        "–í–∏–ø—Ä–∞–≤ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ—ñ—é, –ø—É–Ω–∫—Ç—É–∞—Ü—ñ—é —Ç–∞ –±–∞–∑–æ–≤—É –≥—Ä–∞–º–∞—Ç–∏–∫—É. " +
        "–ó–±–µ—Ä—ñ–≥–∞–π –∑–º—ñ—Å—Ç. –ù–ï –ø–µ—Ä–µ–∫–ª–∞–¥–∞–π –∞–Ω–≥–ª—ñ–π—Å—å–∫—ñ —Å–ª–æ–≤–∞ –π –Ω–µ –∑–º—ñ–Ω—é–π —ó—Ö."
      );
    case "en-clean":
      return (
        "You are an English proofreader. " +
        "Fix spelling, punctuation and basic grammar, but do not change the meaning."
      );
    case "uk-en-mix":
      return (
        "–¢–∏ –∫–æ—Ä–µ–∫—Ç–æ—Ä –∑–º—ñ—à–∞–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –∑ –≤—Å—Ç–∞–≤–∫–∞–º–∏ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é. " +
        "–í–∏–ø—Ä–∞–≤ –ª–∏—à–µ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É —á–∞—Å—Ç–∏–Ω—É —Ç–µ–∫—Å—Ç—É. " +
        "–ê–Ω–≥–ª—ñ–π—Å—å–∫—ñ —Å–ª–æ–≤–∞ —ñ —Ñ—Ä–∞–∑–∏ –Ω–µ –ø–µ—Ä–µ–∫–ª–∞–¥–∞–π —ñ –Ω–µ –∑–º—ñ–Ω—é–π."
      );
    default:
      return (
        "You are a careful text cleaner. " +
        "Fix obvious mistakes but preserve the original meaning and style as much as possible."
      );
  }
}

/**
 * –õ–µ–≥–∫–∏–π health-check –¥–ª—è –±–µ–∫–µ–Ω–¥–∞ —Ç–∞ –∫–ª—é—á–∞ OpenAI.
 *
 * GET /health
 *
 * –í—ñ–¥–ø–æ–≤—ñ–¥—å:
 *  - 200 { ok: true, model, latencyMs }
 *  - 500 { ok: false, stage: "env" | "openai", error }
 */
app.get("/health", async (req, res) => {
  if (!process.env.OPENAI_API_KEY) {
    return res.status(500).json({
      ok: false,
      stage: "env",
      error: "OPENAI_API_KEY is not set",
    });
  }

  try {
    const started = Date.now();

    const response = await openai.responses.create({
      model: "gpt-4o-mini",
      input: "ping",
    });

    const latencyMs = Date.now() - started;
    const text = (response.output_text || "").trim();

    return res.json({
      ok: true,
      stage: "openai",
      model: "gpt-4o-mini",
      latencyMs,
      sample: text,
    });
  } catch (err) {
    console.error("[Golos] /health OpenAI error:", err);
    return res.status(500).json({
      ok: false,
      stage: "openai",
      error: err.message || String(err),
    });
  }
});

app.post("/process", async (req, res) => {
  const { mode = "uk-clean", text } = req.body || {};

  if (typeof text !== "string" || !text.trim()) {
    return res
      .status(400)
      .json({ error: "field 'text' (non-empty string) is required" });
  }

  if (!process.env.OPENAI_API_KEY) {
    return res.status(500).json({ error: "OPENAI_API_KEY env var is not set" });
  }

  try {
    const instructions = getInstructions(mode);

    const response = await openai.responses.create({
      model: "gpt-4o-mini",
      input: text,
      instructions,
    });

    const processedText = (response.output_text || "").trim() || text;

    return res.json({ text: processedText });
  } catch (err) {
    console.error("[Golos] /process OpenAI error:", err);
    return res.status(500).json({
      error: "openai_error",
      message: err.message || "Failed to process text with OpenAI",
    });
  }
});

app.listen(PORT, () => {
  console.log(`golos-api listening on http://127.0.0.1:${PORT}`);
});
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\legacy
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\legacy\dictation.js
--------------------------------------------------
let dictationActive = false;

const btn = document.getElementById("toggle");
const statusEl = document.getElementById("status");
const liveEl = document.getElementById("live");

function updateUI() {
  if (dictationActive) {
    btn.textContent = "‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏";
    statusEl.textContent = "–°–ª—É—Ö–∞—é‚Ä¶";
  } else {
    btn.textContent = "üéô –ü–æ—á–∞—Ç–∏ –¥–∏–∫—Ç—É–≤–∞–Ω–Ω—è";
    statusEl.textContent = "";
    liveEl.textContent = "";
  }
}

btn.addEventListener("click", () => {
  const type = dictationActive
    ? "GOLOS_STOP_DICTATION"
    : "GOLOS_START_DICTATION";

  chrome.runtime.sendMessage({ type }, (res) => {
    dictationActive = !dictationActive;
    updateUI();
  });
});

updateUI();

// –û—Ç—Ä–∏–º—É—î–º–æ —Ç–µ–∫—Å—Ç –≤—ñ–¥ content-script
chrome.runtime.onMessage.addListener((msg) => {
  if (msg.type === "DICTATION_INTERIM") {
    liveEl.textContent = msg.text;
  }

  if (msg.type === "DICTATION_FINAL") {
    liveEl.textContent = msg.text;
  }
});
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\options
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\options\options.js
--------------------------------------------------
// options/options.js

const langSelect = document.getElementById("lang");
const saveBtn = document.getElementById("save");
const statusSpan = document.getElementById("status");

// 1. –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
document.addEventListener("DOMContentLoaded", () => {
  chrome.storage.sync.get({ golosLang: "uk-UA" }, (items) => {
    langSelect.value = items.golosLang;
  });
});

// 2. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è
saveBtn.addEventListener("click", () => {
  const lang = langSelect.value;

  chrome.storage.sync.set({ golosLang: lang }, () => {
    // –ï—Ñ–µ–∫—Ç "–ó–±–µ—Ä–µ–∂–µ–Ω–æ"
    statusSpan.style.opacity = "1";
    setTimeout(() => {
      statusSpan.style.opacity = "0";
    }, 1500);

    console.log("[Golos Options] Saved:", lang);
  });
});
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\popup
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\popup\popup.js
--------------------------------------------------
document.addEventListener("DOMContentLoaded", async () => {
  const langSelect = document.getElementById("lang-select");
  const statusDot = document.getElementById("status-dot");
  const statusText = document.getElementById("status-text");

  // 1. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω—É –º–æ–≤—É (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º uk-UA)
  chrome.storage.sync.get({ golosLang: "uk-UA" }, (items) => {
    langSelect.value = items.golosLang;
  });

  // 2. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø—Ä–∏ –∑–º—ñ–Ω—ñ
  langSelect.addEventListener("change", () => {
    const newVal = langSelect.value;
    chrome.storage.sync.set({ golosLang: newVal }, () => {
      console.log("Language saved:", newVal);
      // –ú–æ–∂–Ω–∞ –±–ª–∏–º–Ω—É—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É, —â–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ
    });
  });

  // 3. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∂–∏–≤–∏–π Engine
  const engineUrl = chrome.runtime.getURL("engine/engine.html");
  const tabs = await chrome.tabs.query({ url: engineUrl });

  if (tabs.length > 0) {
    statusDot.classList.add("ok");
    statusText.textContent = "Engine Ready";
  } else {
    statusDot.classList.remove("ok");
    statusText.textContent = "Engine Sleeping";
  }
});
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\utils
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\utils\messaging.js
--------------------------------------------------
export const MSG = {
  // Host -> Router -> Engine
  CMD_START_SESSION: "CMD_START_SESSION",
  CMD_STOP_SESSION: "CMD_STOP_SESSION",

  // Engine -> Router -> Host
  EVENT_STATE_CHANGE: "EVENT_STATE_CHANGE", // connecting, listening, idle
  EVENT_TRANSCRIPT: "EVENT_TRANSCRIPT", // text data
  EVENT_ERROR: "EVENT_ERROR",
};
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\md
--------------------------------------------------
