D:\ProjectsVVV\ChromeExtension\golos
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\assets
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\assets\icons
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\background
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\background\service-worker.js
--------------------------------------------------
import { MSG } from "../utils/messaging.js";

console.log("[Golos BG] Router v2.1 Fixed");

let engineTabId = null;

// --- 1. –ö–µ—Ä—É–≤–∞–Ω–Ω—è –≤–∫–ª–∞–¥–∫–æ—é-–¥–≤–∏–≥—É–Ω–æ–º ---

async function ensureEngineTab() {
  const engineUrl = chrome.runtime.getURL("engine/engine.html");
  try {
    const tabs = await chrome.tabs.query({ url: engineUrl });
    if (tabs.length > 0) {
      engineTabId = tabs[0].id;
      return engineTabId;
    }
    const newTab = await chrome.tabs.create({
      url: engineUrl,
      pinned: true,
      active: false,
    });
    engineTabId = newTab.id;
    return engineTabId;
  } catch (e) {
    console.error("[Golos BG] Engine error:", e);
    return null;
  }
}

// --- 2. –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞–Ω—É ---

function setVisualState(state) {
  // state: 'idle' | 'listening' | 'error'

  if (state === "listening") {
    // üî¥ –°—Ç–∞–Ω –ó–ê–ü–ò–°–£
    chrome.action.setIcon({
      path: {
        16: "assets/icons/icon-red-16.png",
        32: "assets/icons/icon-red-32.png",
        48: "assets/icons/icon-red-48.png",
        128: "assets/icons/icon-red-128.png",
      },
    });
    // –í–ê–ñ–õ–ò–í–û: –ó–∞–ª–∏—à–∞—î–º–æ "ON", –±–æ –Ω–∞ –Ω—å–æ–º—É —Ç—Ä–∏–º–∞—î—Ç—å—Å—è –ª–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ–º–∏–∫–∞—á–∞!
    chrome.action.setBadgeText({ text: "ON" });
    chrome.action.setBadgeBackgroundColor({ color: "#ef4444" });
  } else if (state === "idle") {
    // üü¢ –°—Ç–∞–Ω –°–ü–û–ö–û–Æ
    chrome.action.setIcon({
      path: {
        16: "assets/icons/icon-green-16.png",
        32: "assets/icons/icon-green-32.png",
        48: "assets/icons/icon-green-48.png",
        128: "assets/icons/icon-green-128.png",
      },
    });
    // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ —Ç–µ–∫—Å—Ç
    chrome.action.setBadgeText({ text: "" });
  } else if (state === "error") {
    // ‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞
    chrome.action.setBadgeText({ text: "ERR" });
    chrome.action.setBadgeBackgroundColor({ color: "#000000" });
  }
}

// --- 3. –ì–æ–ª–æ–≤–Ω–∏–π –ø–µ—Ä–µ–º–∏–∫–∞—á (Toggle) ---

async function toggleSession() {
  // –î–∂–µ—Ä–µ–ª–æ –ø—Ä–∞–≤–¥–∏ ‚Äî —Ç–µ–∫—Å—Ç –Ω–∞ –±–µ–π–¥–∂—ñ
  const badgeText = await chrome.action.getBadgeText({});
  const isRunning = badgeText === "ON";

  if (isRunning) {
    // === STOP ===
    console.log("[Golos BG] Action: STOP");
    if (engineTabId) {
      chrome.tabs.sendMessage(engineTabId, { type: MSG.CMD_STOP_SESSION });
      // –ü—Ä–∏–º—É—Å–æ–≤–æ —Å–∫–∏–¥–∞—î–º–æ –≤—ñ–∑—É–∞–ª, –Ω–µ —á–µ–∫–∞—é—á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
      setVisualState("idle");
    }
  } else {
    // === START ===
    console.log("[Golos BG] Action: START");

    // 1. –®—É–∫–∞—î–º–æ –∞–∫—Ç–∏–≤–Ω—É –≤–∫–ª–∞–¥–∫—É
    const tabs = await chrome.tabs.query({
      active: true,
      lastFocusedWindow: true,
    });
    const activeTab = tabs[0];

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    if (!activeTab || !activeTab.id || activeTab.url.startsWith("chrome://")) {
      console.warn("Cannot dictate on this tab");
      chrome.action.setBadgeText({ text: "ERR" });
      setTimeout(() => chrome.action.setBadgeText({ text: "" }), 1500);
      return;
    }

    // 2. –ü–ò–¢–ê–Ñ–ú–û —Å—Ç–æ—Ä—ñ–Ω–∫—É: "–ß–∏ —î –∫—É–¥–∏ –ø–∏—Å–∞—Ç–∏?"
    try {
      const response = await chrome.tabs.sendMessage(activeTab.id, {
        type: "CMD_ShowWidget",
      });

      if (!response || !response.ok) {
        console.warn("[Golos BG] Page said NO (no input field).");
        chrome.action.setBadgeText({ text: "NO" });
        setTimeout(() => chrome.action.setBadgeText({ text: "" }), 1500);
        return;
      }
    } catch (err) {
      console.warn("[Golos BG] Content script not ready or error:", err);
      // –Ø–∫—â–æ —Å–∫—Ä–∏–ø—Ç –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–≤ ‚Äî –ø—Ä–æ–±—É—î–º–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –π–æ–≥–æ (–∞–±–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É)
      chrome.action.setBadgeText({ text: "?" });
      return;
    }

    // 3. –ó–∞–ø—É—Å–∫–∞—î–º–æ –¥–≤–∏–≥—É–Ω
    ensureEngineTab().then((engId) => {
      if (!engId) return;

      // –°—Ç–∞–≤–∏–º–æ —Å—Ç–∞—Ç—É—Å –ó–ê–†–ê–ó, —â–æ–± —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—ñ–¥–≥—É–∫–Ω—É–≤—Å—è –º–∏—Ç—Ç—î–≤–æ
      setVisualState("listening");

      chrome.tabs.sendMessage(engId, {
        type: MSG.CMD_START_SESSION,
        targetTabId: activeTab.id,
      });
    });
  }
}

// --- 4. Listeners ---

// –ö–ª—ñ–∫ –ø–æ —ñ–∫–æ–Ω—Ü—ñ (–õ–ö–ú)
chrome.action.onClicked.addListener((tab) => {
  toggleSession();
});

// –ì–∞—Ä—è—á–∞ –∫–ª–∞–≤—ñ—à–∞
chrome.commands.onCommand.addListener((command) => {
  if (command === "golos-process-selection") {
    toggleSession();
  }
});

// –°–ª—É—Ö–∞—á –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  // –Ø–∫—â–æ –≤—ñ–¥–∂–µ—Ç –ø—Ä–æ—Å–∏—Ç—å –∑—É–ø–∏–Ω–∏—Ç–∏—Å—å (—Ö—Ä–µ—Å—Ç–∏–∫)
  if (message.type === MSG.CMD_STOP_SESSION) {
    if (engineTabId) {
      chrome.tabs.sendMessage(engineTabId, { type: MSG.CMD_STOP_SESSION });
      setVisualState("idle");
    }
  }

  // –¢—Ä–∞–Ω–∑–∏—Ç –¥–∞–Ω–∏—Ö (Engine <-> Content)
  if (
    message.type === MSG.EVENT_TRANSCRIPT ||
    message.type === MSG.EVENT_STATE_CHANGE
  ) {
    // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è UI –ø—Ä–∏ –∞–≤—Ç–æ-—Å—Ç–æ–ø—ñ
    if (message.type === MSG.EVENT_STATE_CHANGE) {
      // –Ø–∫—â–æ engine —Å–∞–º –ø–µ—Ä–µ–π—à–æ–≤ —É idle (—Ç–∞–π–º–∞—É—Ç) -> –æ–Ω–æ–≤–ª—é—î–º–æ —ñ–∫–æ–Ω–∫—É
      if (message.state === "idle" || message.state === "error") {
        setVisualState("idle");
      }
    }

    const destTabId = message.targetTabId;
    if (destTabId) {
      chrome.tabs.sendMessage(destTabId, message).catch(() => {});
    }
  }
});

// --- 5. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é (Settings) ---
chrome.runtime.onInstalled.addListener(() => {
  ensureEngineTab();
  chrome.contextMenus.create({
    id: "open-settings",
    title: "‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Golos",
    contexts: ["all"],
  });
});

chrome.contextMenus.onClicked.addListener((info, tab) => {
  if (info.menuItemId === "open-settings") {
    chrome.runtime.openOptionsPage();
  }
});

// --- 6. –ê–≤—Ç–æ-—Å—Ç–æ–ø –ø—Ä–∏ –∑–º—ñ–Ω—ñ –≤–∫–ª–∞–¥–∫–∏ ---
chrome.tabs.onActivated.addListener(async (activeInfo) => {
  const badgeText = await chrome.action.getBadgeText({});
  const isRunning = badgeText === "ON";

  if (isRunning) {
    console.log("[Golos BG] Tab changed. Auto-stopping session.");
    if (engineTabId) {
      chrome.tabs.sendMessage(engineTabId, { type: MSG.CMD_STOP_SESSION });
    }
    setVisualState("idle");
  }
});

// –°—Ç–∞—Ä—Ç
chrome.runtime.onStartup.addListener(() => ensureEngineTab());
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\content
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\content\content.js
--------------------------------------------------
(async () => {
  try {
    const srcMessaging = chrome.runtime.getURL("utils/messaging.js");
    const srcWidget = chrome.runtime.getURL("content/dom-injector.js");
    const srcInput = chrome.runtime.getURL("content/input-simulator.js");

    const { MSG } = await import(srcMessaging);
    const { GolosWidget } = await import(srcWidget);
    const { insertText, getActiveEditable } = await import(srcInput);

    console.log("[Golos Host] All modules loaded");
    const widget = new GolosWidget();

    // –û–±—Ä–æ–±–∫–∞ –∫–ª—ñ–∫—É –Ω–∞ —Ö—Ä–µ—Å—Ç–∏–∫
    widget.onStopClick(() => {
      console.log("[Golos Host] User clicked Stop");
      chrome.runtime.sendMessage({ type: MSG.CMD_STOP_SESSION });
      widget.hide();
    });

    chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
      // 1. –ö–æ–º–∞–Ω–¥–∞ "–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–¥–∂–µ—Ç" - —Ç–µ–ø–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å!
      if (message.type === "CMD_ShowWidget") {
        const el = getActiveEditable();
        if (el) {
          widget.show();
          // –ö–∞–∂–µ–º–æ Background'—É: "–í—Å–µ –æ–∫, –ø–æ–ª–µ —î"
          sendResponse({ ok: true });
        } else {
          // console.warn("No editable element found");
          // –ö–∞–∂–µ–º–æ Background'—É: "–°—Ç–æ–ø! –ù–µ–º–∞—î –ø–æ–ª—è"
          sendResponse({ ok: false });
        }
      }

      // ... —Ä–µ—à—Ç–∞ –∫–æ–¥—É (EVENT_STATE_CHANGE, EVENT_TRANSCRIPT) –±–µ–∑ –∑–º—ñ–Ω ...
      if (message.type === MSG.EVENT_STATE_CHANGE) {
        widget.setStatusCode(message.state);
        if (message.state === "idle") {
          setTimeout(() => widget.hide(), 500);
        }
      }

      if (message.type === MSG.EVENT_TRANSCRIPT) {
        widget.updateText(message.text, message.isFinal);
        if (message.isFinal) {
          const el = getActiveEditable();
          if (el) insertText(el, message.text);
        }
      }

      // –í–∞–∂–ª–∏–≤–æ: –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ true, —â–æ–± sendResponse –ø—Ä–∞—Ü—é–≤–∞–≤ –∫–æ—Ä–µ–∫—Ç–Ω–æ (—Ö–æ—á–∞ —Ç—É—Ç –º–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î–º–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —Ü–µ —Ö–æ—Ä–æ—à–∞ –∑–≤–∏—á–∫–∞)
      // –ê–ª–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –º–æ–∂–Ω–∞ —ñ –Ω–µ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏.
    });
  } catch (err) {
    console.error("[Golos Host] Error:", err);
  }
})();
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\content\dom-injector.js
--------------------------------------------------
export class GolosWidget {
  constructor() {
    this.host = null;
    this.shadow = null;
    this.root = null;
    this.statusDot = null;
    this.statusText = null;
    this.contentArea = null;
    this.closeBtn = null;
    this._isMounted = false;
    this.onStopCallback = null;
  }

  onStopClick(callback) {
    this.onStopCallback = callback;
  }

  mount() {
    if (this._isMounted) return;

    // –°—Ç–≤–æ—Ä—é—î–º–æ Host
    this.host = document.createElement("div");
    this.host.id = "golos-shadow-host";

    // –í–ê–ñ–õ–ò–í–û: –ü–æ—á–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è –≤–ø–ª–∏–≤—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    this.host.style.display = "block";
    this.host.style.zIndex = "2147483647"; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π Z-index

    this.shadow = this.host.attachShadow({ mode: "open" });

    const linkElem = document.createElement("link");
    linkElem.setAttribute("rel", "stylesheet");
    linkElem.setAttribute("href", chrome.runtime.getURL("assets/styles.css"));
    this.shadow.appendChild(linkElem);

    const wrapper = document.createElement("div");
    wrapper.className = "golos-widget golos-hidden";
    wrapper.innerHTML = `
      <div class="golos-header" id="drag-handle">
        <div class="golos-status">
          <div class="golos-dot"></div>
          <span class="golos-status-text">Golos</span>
        </div>
        <div class="golos-close" style="cursor: pointer; padding: 4px; font-weight: bold;">‚úñ</div>
      </div>
      <div class="golos-content">
        <span class="golos-placeholder">–ì–æ–≤–æ—Ä—ñ—Ç—å...</span>
      </div>
    `;
    this.shadow.appendChild(wrapper);

    this.root = wrapper;
    this.statusDot = wrapper.querySelector(".golos-dot");
    this.statusText = wrapper.querySelector(".golos-status-text");
    this.contentArea = wrapper.querySelector(".golos-content");
    this.closeBtn = wrapper.querySelector(".golos-close");

    // –ó—É–ø–∏–Ω–∫–∞
    this.closeBtn.addEventListener("click", (e) => {
      e.stopPropagation(); // –©–æ–± –∫–ª—ñ–∫ –Ω–µ –ø–æ—á–∏–Ω–∞–≤ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è
      if (this.onStopCallback) this.onStopCallback();
    });

    document.body.appendChild(this.host);

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è (Header - —Ü–µ —Ä—É—á–∫–∞)
    const header = wrapper.querySelector(".golos-header");
    this.makeDraggable(header);

    this._isMounted = true;
  }

  // --- –ü–û–ö–†–ê–©–ï–ù–ê –õ–û–ì–Ü–ö–ê DRAG & DROP ---
  makeDraggable(triggerElement) {
    triggerElement.addEventListener("mousedown", (e) => {
      e.preventDefault(); // –ó–∞–±–æ—Ä–æ–Ω—è—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É

      // 1. –î–µ –∑–∞—Ä–∞–∑ –≤—ñ–¥–∂–µ—Ç?
      const rect = this.host.getBoundingClientRect();

      // 2. –î–µ –º–∏—à–∫–∞ –≤—ñ–¥–Ω–æ—Å–Ω–æ –ª—ñ–≤–æ–≥–æ –≤–µ—Ä—Ö–Ω—å–æ–≥–æ –∫—É—Ç–∞ –≤—ñ–¥–∂–µ—Ç–∞?
      const shiftX = e.clientX - rect.left;
      const shiftY = e.clientY - rect.top;

      // 3. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ —Ä—É—Ö—É
      this.host.style.transition = "none"; // –í–∏–º–∏–∫–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é, —â–æ–± –Ω–µ "–ª–∞–≥–æ–¥–∏–ª–æ" –ø—Ä–∏ —Ä—É—Å—ñ

      // –í–ê–ñ–õ–ò–í–û: –í—ñ–¥—Ä–∏–≤–∞—î–º–æ –≤—ñ–¥ –ø—Ä–∞–≤–æ–≥–æ –Ω–∏–∂–Ω—å–æ–≥–æ –∫—É—Ç–∞
      this.host.style.bottom = "auto";
      this.host.style.right = "auto";
      // –§—ñ–∫—Å—É—î–º–æ –ø–æ—Ç–æ—á–Ω—É –ø–æ–∑–∏—Ü—ñ—é –≤ left/top, —â–æ–± –Ω–µ —Å—Ç—Ä–∏–±–Ω—É–ª–æ
      this.host.style.left = rect.left + "px";
      this.host.style.top = rect.top + "px";

      const onMouseMove = (moveEvent) => {
        // –ù–æ–≤—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
        let newLeft = moveEvent.clientX - shiftX;
        let newTop = moveEvent.clientY - shiftY;

        // (–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ) –û–±–º–µ–∂–µ–Ω–Ω—è, —â–æ–± –Ω–µ –≤–∏—Ç—è–≥–Ω—É—Ç–∏ –∑–∞ –º–µ–∂—ñ –µ–∫—Ä–∞–Ω—É
        const winWidth = window.innerWidth;
        const winHeight = window.innerHeight;
        const hostWidth = this.host.offsetWidth;
        const hostHeight = this.host.offsetHeight;

        // –ù–µ –¥–∞—î–º–æ –≤–∏–π—Ç–∏ –∑–∞ –ª—ñ–≤–∏–π/–≤–µ—Ä—Ö–Ω—ñ–π –∫—Ä–∞–π
        if (newLeft < 0) newLeft = 0;
        if (newTop < 0) newTop = 0;
        // –ù–µ –¥–∞—î–º–æ –≤–∏–π—Ç–∏ –∑–∞ –ø—Ä–∞–≤–∏–π/–Ω–∏–∂–Ω—ñ–π –∫—Ä–∞–π
        if (newLeft + hostWidth > winWidth) newLeft = winWidth - hostWidth;
        if (newTop + hostHeight > winHeight) newTop = winHeight - hostHeight;

        this.host.style.left = newLeft + "px";
        this.host.style.top = newTop + "px";
      };

      const onMouseUp = () => {
        // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ —Å–ª—É—Ö–∞—á—ñ–≤
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);

        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é (—è–∫—â–æ –≤–æ–Ω–∞ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–ª—è –ø–æ—è–≤–∏/–∑–Ω–∏–∫–Ω–µ–Ω–Ω—è)
        // this.host.style.transition = "";
      };

      // –°–ª—É—Ö–∞—î–º–æ —Ä—É—Ö –ø–æ –≤—Å—å–æ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É
      document.addEventListener("mousemove", onMouseMove);
      document.addEventListener("mouseup", onMouseUp);
    });
  }
  // ---------------------------

  show() {
    if (!this._isMounted) this.mount();

    // –û—á–∏—â–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É
    this.contentArea.innerHTML =
      '<span class="golos-placeholder">–ì–æ–≤–æ—Ä—ñ—Ç—å...</span>';

    this.root.classList.remove("golos-hidden");
    this.setStatusCode("connecting");
  }

  hide() {
    if (this.root) this.root.classList.add("golos-hidden");
  }

  updateText(text, isFinal) {
    if (!text) {
      this.contentArea.innerHTML =
        '<span class="golos-placeholder">–ì–æ–≤–æ—Ä—ñ—Ç—å...</span>';
      return;
    }
    this.contentArea.textContent = text;
  }

  setStatusCode(code) {
    this.statusDot.className = "golos-dot";
    switch (code) {
      case "listening":
        this.statusDot.classList.add("listening");
        this.statusText.textContent = "–°–ª—É—Ö–∞—é...";
        break;
      case "idle":
        this.statusText.textContent = "Golos";
        break;
      case "error":
        this.statusText.textContent = "–ü–æ–º–∏–ª–∫–∞";
        break;
      case "connecting":
        this.statusText.textContent = "–ó–∞–ø—É—Å–∫...";
        break;
      default:
        this.statusText.textContent = "Golos";
    }
  }
}
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\content\input-simulator.js
--------------------------------------------------
export function getActiveEditable() {
  const el = document.activeElement;
  if (!el) return null;

  const isInput =
    el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement;
  const isContentEditable = el.isContentEditable;

  if (isInput || isContentEditable) {
    return el;
  }
  return null;
}

export function insertText(el, text) {
  if (!el || !text) return;

  const isInput =
    el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement;

  if (isInput) {
    const start = el.selectionStart || 0;
    const end = el.selectionEnd || 0;
    const originalValue = el.value;

    const prefix = originalValue.substring(0, start);
    const suffix = originalValue.substring(end);

    const spacer = prefix.length > 0 && !prefix.endsWith(" ") ? " " : "";

    el.value = prefix + spacer + text + suffix;

    const newCursorPos = start + spacer.length + text.length;
    el.selectionStart = el.selectionEnd = newCursorPos;

    el.dispatchEvent(new Event("input", { bubbles: true }));
    el.dispatchEvent(new Event("change", { bubbles: true }));
  } else {
    // –î–ª—è contenteditable
    document.execCommand("insertText", false, text);
  }
  console.log("[Golos Input] Inserted:", text);
}
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\engine
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\engine\engine.js
--------------------------------------------------
import { MSG } from "../utils/messaging.js";

console.log("[Golos Engine] Ready to listen.");

let recognition = null; // SpeechRecognition instance
let currentTargetTabId = null; // Tab ID to send transcripts to
let silenceTimer = null; // Timer for silence detection
const SILENCE_TIMEOUT_MS = 20000; // 20 seconds

// --- –°–õ–û–í–ù–ò–ö –ú–ê–ö–†–û–°–Ü–í ---
const MACROS = {
  –∫–æ–º–∞: ",",
  –∫—Ä–∞–ø–∫–∞: ".",
  "–∑–Ω–∞–∫ –ø–∏—Ç–∞–Ω–Ω—è": "?",
  "–∑–Ω–∞–∫ –æ–∫–ª–∏–∫—É": "!",
  –¥–µ—Ñ—ñ—Å: "-",
  –¥–≤–æ–∫—Ä–∞–ø–∫–∞: ":",
  —Ç–∏—Ä–µ: " ‚Äî",
  "–Ω–æ–≤–∏–π —Ä—è–¥–æ–∫": "\n",
  –∞–±–∑–∞—Ü: "\n\n",
  "–¥—É–∂–∫–∞ –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è": "(",
  "–¥—É–∂–∫–∞ –∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è": ")",
  —Å–º–∞–π–ª–∏–∫: "üôÇ",
};

function applyMacros(text) {
  if (!text) return text;

  let processed = text;

  // 1. –ó–∞–º—ñ–Ω–∞ —Å–ª—ñ–≤ –Ω–∞ —Å–∏–º–≤–æ–ª–∏
  for (const [key, value] of Object.entries(MACROS)) {
    const regex = new RegExp(`(^|\\s)${key}(?=$|\\s|[.,?!])`, "gi");
    processed = processed.replace(regex, (match, prefix) => {
      // –Ø–∫—â–æ —Ü–µ —Ä–æ–∑–¥—ñ–ª–æ–≤–∏–π –∑–Ω–∞–∫, –º–∏ –Ω–µ —Ö–æ—á–µ–º–æ –ø—Ä–æ–±—ñ–ª –ø–µ—Ä–µ–¥ –Ω–∏–º (–æ–∫—Ä—ñ–º –¥—É–∂–∫–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è)
      if ([".", ",", "?", "!", ":", ")"].includes(value)) {
        return value;
      }
      return prefix + value;
    });
  }

  // 2. –ß–∏—Å—Ç–∫–∞ –ø—Ä–æ–±—ñ–ª—ñ–≤ (FIX –¥–ª—è –¥—É–∂–æ–∫)

  // –ü—Ä–∏–±—Ä–∞—Ç–∏ –ø—Ä–æ–±—ñ–ª–∏ –ü–ï–†–ï–î: . , ! ? : )
  processed = processed.replace(/\s+([.,?!:);])/g, "$1");

  // –ü—Ä–∏–±—Ä–∞—Ç–∏ –ø—Ä–æ–±—ñ–ª–∏ –ü–Ü–°–õ–Ø: (
  processed = processed.replace(/(\()\s+/g, "$1");

  // –î–æ–¥–∞—Ç–∏ –ø—Ä–æ–±—ñ–ª –ü–Ü–°–õ–Ø –∫–æ–º–∏/–∫—Ä–∞–ø–∫–∏, —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ "–ø—Ä–∏–≤—ñ—Ç,—è–∫")
  processed = processed.replace(/([.,?!:;])(?=[^\s])/g, "$1 ");

  return processed;
}
// --- –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –†–û–ó–ü–Ü–ó–ù–ê–í–ê–ù–ù–Ø ---
async function initRecognition() {
  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return null;

  const { golosLang } = await chrome.storage.sync.get({ golosLang: "uk-UA" });
  console.log(`[Golos Engine] Lang: ${golosLang}`);

  const rec = new SpeechRecognition();
  rec.continuous = true;
  rec.interimResults = true;
  rec.lang = golosLang;

  rec.onstart = () => {
    console.log("[Golos Engine] ON");
    sendState("listening");
    resetSilenceTimer();
  };

  rec.onend = () => {
    console.log("[Golos Engine] OFF");
    sendState("idle");
    clearTimeout(silenceTimer);
  };

  rec.onresult = (event) => {
    resetSilenceTimer();

    let interim = "";
    let final = "";

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const res = event.results[i];
      if (res.isFinal) {
        final += res[0].transcript;
      } else {
        interim += res[0].transcript;
      }
    }

    // –ó–ê–°–¢–û–°–û–í–£–Ñ–ú–û –ú–ê–ö–†–û–° –¢–Ü–õ–¨–ö–ò –î–û –§–Ü–ù–ê–õ–¨–ù–û–ì–û –¢–ï–ö–°–¢–£
    if (final) {
      final = applyMacros(final);
      // –ö–∞–ø—ñ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–µ—Ä—à–æ—ó –ª—ñ—Ç–µ—Ä–∏ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É
      final = final.charAt(0).toUpperCase() + final.slice(1);
    }

    if (currentTargetTabId) {
      chrome.runtime.sendMessage({
        type: MSG.EVENT_TRANSCRIPT,
        text: final || interim,
        isFinal: !!final,
        targetTabId: currentTargetTabId,
      });
    }
  };

  rec.onerror = (e) => {
    if (e.error !== "no-speech") sendState("error");
  };
  return rec;
}
// --- –¢–ê–ô–ú–ï–† –ë–ï–ó–î–Ü–Ø–õ–¨–ù–û–°–¢–Ü ---
function resetSilenceTimer() {
  clearTimeout(silenceTimer);
  silenceTimer = setTimeout(() => {
    console.log("[Golos Engine] Silence stop.");
    stopSession();
  }, SILENCE_TIMEOUT_MS);
}
// --- –ó–£–ü–ò–ù–ö–ê –°–ï–°–Ü–á ---
function stopSession() {
  if (recognition) recognition.stop();
  updateStatusUI("Idle");
}
// --- –í–Ü–î–ü–†–ê–í–ö–ê –°–¢–ê–ù–£ ---
function sendState(state) {
  if (currentTargetTabId) {
    chrome.runtime.sendMessage({
      type: MSG.EVENT_STATE_CHANGE,
      state: state,
      targetTabId: currentTargetTabId,
    });
  }
}
// --- –û–ë–†–û–ë–ö–ê –ü–û–í–Ü–î–û–ú–õ–ï–ù–¨ ---
chrome.runtime.onMessage.addListener((message) => {
  if (message.type === MSG.CMD_START_SESSION) {
    currentTargetTabId = message.targetTabId;
    if (recognition) recognition.abort();
    initRecognition().then((rec) => {
      recognition = rec;
      try {
        recognition.start();
        updateStatusUI(`Listening ${currentTargetTabId}`);
      } catch (e) {}
    });
    return true;
  }
  if (message.type === MSG.CMD_STOP_SESSION) stopSession();
});
// --- UI –°–¢–ê–¢–£–° ---
function updateStatusUI(text) {
  const el = document.getElementById("status");
  if (el) el.textContent = text;
}
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\golos-api
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\golos-api\index.js
--------------------------------------------------
import "dotenv/config";
import express from "express";
import cors from "cors";
import OpenAI from "openai";

const app = express();
const PORT = 3000;

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–ª—ñ—î–Ω—Ç–∞ OpenAI
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

app.use(cors());
app.use(express.json());

function getInstructions(mode) {
  switch (mode) {
    case "uk-clean":
      return (
        "–¢–∏ –∫–æ—Ä–µ–∫—Ç–æ—Ä —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—ó –º–æ–≤–∏. " +
        "–í–∏–ø—Ä–∞–≤ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ—ñ—é, –ø—É–Ω–∫—Ç—É–∞—Ü—ñ—é —Ç–∞ –±–∞–∑–æ–≤—É –≥—Ä–∞–º–∞—Ç–∏–∫—É. " +
        "–ó–±–µ—Ä—ñ–≥–∞–π –∑–º—ñ—Å—Ç. –ù–ï –ø–µ—Ä–µ–∫–ª–∞–¥–∞–π –∞–Ω–≥–ª—ñ–π—Å—å–∫—ñ —Å–ª–æ–≤–∞ –π –Ω–µ –∑–º—ñ–Ω—é–π —ó—Ö."
      );
    case "en-clean":
      return (
        "You are an English proofreader. " +
        "Fix spelling, punctuation and basic grammar, but do not change the meaning."
      );
    case "uk-en-mix":
      return (
        "–¢–∏ –∫–æ—Ä–µ–∫—Ç–æ—Ä –∑–º—ñ—à–∞–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –∑ –≤—Å—Ç–∞–≤–∫–∞–º–∏ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é. " +
        "–í–∏–ø—Ä–∞–≤ –ª–∏—à–µ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É —á–∞—Å—Ç–∏–Ω—É —Ç–µ–∫—Å—Ç—É. " +
        "–ê–Ω–≥–ª—ñ–π—Å—å–∫—ñ —Å–ª–æ–≤–∞ —ñ —Ñ—Ä–∞–∑–∏ –Ω–µ –ø–µ—Ä–µ–∫–ª–∞–¥–∞–π —ñ –Ω–µ –∑–º—ñ–Ω—é–π."
      );
    default:
      return (
        "You are a careful text cleaner. " +
        "Fix obvious mistakes but preserve the original meaning and style as much as possible."
      );
  }
}

/**
 * –õ–µ–≥–∫–∏–π health-check –¥–ª—è –±–µ–∫–µ–Ω–¥–∞ —Ç–∞ –∫–ª—é—á–∞ OpenAI.
 *
 * GET /health
 *
 * –í—ñ–¥–ø–æ–≤—ñ–¥—å:
 *  - 200 { ok: true, model, latencyMs }
 *  - 500 { ok: false, stage: "env" | "openai", error }
 */
app.get("/health", async (req, res) => {
  if (!process.env.OPENAI_API_KEY) {
    return res.status(500).json({
      ok: false,
      stage: "env",
      error: "OPENAI_API_KEY is not set",
    });
  }

  try {
    const started = Date.now();

    const response = await openai.responses.create({
      model: "gpt-4o-mini",
      input: "ping",
    });

    const latencyMs = Date.now() - started;
    const text = (response.output_text || "").trim();

    return res.json({
      ok: true,
      stage: "openai",
      model: "gpt-4o-mini",
      latencyMs,
      sample: text,
    });
  } catch (err) {
    console.error("[Golos] /health OpenAI error:", err);
    return res.status(500).json({
      ok: false,
      stage: "openai",
      error: err.message || String(err),
    });
  }
});

app.post("/process", async (req, res) => {
  const { mode = "uk-clean", text } = req.body || {};

  if (typeof text !== "string" || !text.trim()) {
    return res
      .status(400)
      .json({ error: "field 'text' (non-empty string) is required" });
  }

  if (!process.env.OPENAI_API_KEY) {
    return res.status(500).json({ error: "OPENAI_API_KEY env var is not set" });
  }

  try {
    const instructions = getInstructions(mode);

    const response = await openai.responses.create({
      model: "gpt-4o-mini",
      input: text,
      instructions,
    });

    const processedText = (response.output_text || "").trim() || text;

    return res.json({ text: processedText });
  } catch (err) {
    console.error("[Golos] /process OpenAI error:", err);
    return res.status(500).json({
      error: "openai_error",
      message: err.message || "Failed to process text with OpenAI",
    });
  }
});

app.listen(PORT, () => {
  console.log(`golos-api listening on http://127.0.0.1:${PORT}`);
});
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\legacy
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\legacy\dictation.js
--------------------------------------------------
let dictationActive = false;

const btn = document.getElementById("toggle");
const statusEl = document.getElementById("status");
const liveEl = document.getElementById("live");

function updateUI() {
  if (dictationActive) {
    btn.textContent = "‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏";
    statusEl.textContent = "–°–ª—É—Ö–∞—é‚Ä¶";
  } else {
    btn.textContent = "üéô –ü–æ—á–∞—Ç–∏ –¥–∏–∫—Ç—É–≤–∞–Ω–Ω—è";
    statusEl.textContent = "";
    liveEl.textContent = "";
  }
}

btn.addEventListener("click", () => {
  const type = dictationActive
    ? "GOLOS_STOP_DICTATION"
    : "GOLOS_START_DICTATION";

  chrome.runtime.sendMessage({ type }, (res) => {
    dictationActive = !dictationActive;
    updateUI();
  });
});

updateUI();

// –û—Ç—Ä–∏–º—É—î–º–æ —Ç–µ–∫—Å—Ç –≤—ñ–¥ content-script
chrome.runtime.onMessage.addListener((msg) => {
  if (msg.type === "DICTATION_INTERIM") {
    liveEl.textContent = msg.text;
  }

  if (msg.type === "DICTATION_FINAL") {
    liveEl.textContent = msg.text;
  }
});
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\options
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\options\options.js
--------------------------------------------------
// options/options.js

const langSelect = document.getElementById("lang");
const saveBtn = document.getElementById("save");
const statusSpan = document.getElementById("status");

// 1. –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
document.addEventListener("DOMContentLoaded", () => {
  chrome.storage.sync.get({ golosLang: "uk-UA" }, (items) => {
    langSelect.value = items.golosLang;
  });
});

// 2. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è
saveBtn.addEventListener("click", () => {
  const lang = langSelect.value;

  chrome.storage.sync.set({ golosLang: lang }, () => {
    // –ï—Ñ–µ–∫—Ç "–ó–±–µ—Ä–µ–∂–µ–Ω–æ"
    statusSpan.style.opacity = "1";
    setTimeout(() => {
      statusSpan.style.opacity = "0";
    }, 1500);

    console.log("[Golos Options] Saved:", lang);
  });
});
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\utils
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\golos-extension\utils\messaging.js
--------------------------------------------------
export const MSG = {
  // Host -> Router -> Engine
  CMD_START_SESSION: "CMD_START_SESSION",
  CMD_STOP_SESSION: "CMD_STOP_SESSION",

  // Engine -> Router -> Host
  EVENT_STATE_CHANGE: "EVENT_STATE_CHANGE", // connecting, listening, idle
  EVENT_TRANSCRIPT: "EVENT_TRANSCRIPT", // text data
  EVENT_ERROR: "EVENT_ERROR",
};
--------------------------------------------------
D:\ProjectsVVV\ChromeExtension\golos\md
--------------------------------------------------
